<html>
<head>
<title>Fit My Tent</title>
<link rel="stylesheet" href="tent_style.css">
</head>
<body>

<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item title" href="index.html">
      &#x25b3; Fit my Tent
    </a>
  </div>
  
  <div class="navbar-menu is-active">
    <div class="navbar-end">
      <a href="index.html" class="navbar-item">Home</a>
      <a href="recommend.html" class="navbar-item">Recommend</a>
      <a href="about.html" class="navbar-item">About</a>
      <a href="data.html" class="navbar-item">Data</a>
      <a href="help.html" class="navbar-item">Help</a>
    </div>
  </div>
</nav>

<section class="section">
  <div class="panel" style="width: 50%">
    <p class="panel-heading">
      Tent Explorer
    </p>

    <div class="panel-block">
      <p class="control">
        <table class="table is-borderless is-vertically-aligned is-no-padding">
          <tr>
            <td></td>
            <td colspan="2"><div class="select"><select name="tent-brand-dropdown" id="tent-brand-dropdown" onchange="pickBrand()"></select></div></td>
          </tr>

          <tr>
            <td><label class="label is-small">Tent</label></td>
            <td colspan="2"><div class="select"><select name="tent-dropdown" id="tent-dropdown" onchange="drawFromSettings(true)"></select></div></td>
          </tr>

          <tr class="generic-tent">
            <td><label class="label is-small">Tent Length</label></td>
            <td class="shrink"><input type="number" id="generic-tent-length-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>
          <tr class="generic-tent">
            <td><label class="label is-small">Tent Width</label></td>
            <td class="shrink"><input type="number" id="generic-tent-width-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>
          <tr class="generic-tent">
            <td><label class="label is-small">Tent Height</label></td>
            <td class="shrink"><input type="number" id="generic-tent-height-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr>
            <td><label class="label is-small">Comparison Tent</label></td>
            <td colspan="2"><div class="select"><select name="tent-compare-dropdown" id="tent-compare-dropdown" onchange="drawFromSettings(true)"><option>None</option></div></select>
          </td></tr>

          <tr class="generic-compare-tent">
            <td><label class="label is-small">Tent Length</label></td>
            <td class="shrink"><input type="number" id="generic-compare-tent-length-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>
          <tr class="generic-compare-tent">
            <td><label class="label is-small">Tent Width</label></td>
            <td class="shrink"><input type="number" id="generic-compare-tent-width-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>
          <tr class="generic-compare-tent">
            <td><label class="label is-small">Tent Height</label></td>
            <td class="shrink"><input type="number" id="generic-compare-tent-height-input" class="input input-length" style="width: 6em" value=""></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr>
            <td><label class="label is-small">Your Height</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="height-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td><label class="label is-small">Sitting Height</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="sitting-height-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td><label class="label is-small">Shoulder Width</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="shoulder-width-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td><label class="label is-small">Foot Length</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="foot-length-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td><label class="label is-small">Sleeping Bag Loft</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="loft-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td><label class="label is-small">Sleeping Pad Height</label></td>
            <td class="shrink"><input class="input input-length" type="number" id="pad-height-input" style="width: 6em"></td>
            <td><label class="label units is-small">inches</label></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td></td>
            <td colspan="2"><a href="index.html" id="self-link">(link)</a></td>
          </tr>

          <tr class="advanced-options" style="display: none">
            <td></td>
            <td colspan="2"><input type="checkbox" id="metric-checkbox" onclick="clickMetric()"> Metric</input></td>
          </tr>
          <tr class="advanced-options" style="display: none">
            <td></td>
            <td colspan="2"><input type="checkbox" id="diagonal-checkbox" onclick="clickDiagonal()"> Sleep Diagonally</input></td>
          </tr>

          <tr>
            <td></td>
            <td colspan="2"><button class="button is-small is-rounded" onclick="toggleAdvanced()"><span id="advanced-button" >Advanced &darr;</span></button></td>
          </tr>
        </table>

      </p>
    </div>
  </div>
</section>


<div class="container">
  <table id="legend">
  <tr>
  <td id="usable-area-label" style="background: #B3E2A2; cursor: pointer" onmouseover="highlightTent()" onmouseout="resetHighlightStats()">Usable Area</td>
  <td id="compare-label" style="background: #E0B0E0; cursor: pointer" onmouseover="highlightCompare()" onmouseout="resetHighlightStats()">Compare</td>
  <td style="background: #ffff60">Sleeping Pad</td>
  <td style="background: lightblue">Sleeping Bag</td>
  <td style="background: lightgray">You!</td>
  </tr>
  </table>
</div>

<canvas id="tent-side-canvas" width="400" height="200"></canvas>

<section class="section">
  <table class="table is-striped">
    <tr>
      <th></th>
      <th id="tent-name-stats" class="tent-background"></th>
      <th id="tent-compare-name-stats" class="compare-tent-column compare-tent-background"></th>
    </tr>
    <tr>
      <th>Extra Sleeping Room</th>
      <td style="cursor: pointer" onmouseover="highlightTentSleepingLength()" onmouseout="resetHighlightStats()"><span id="excess-sleeping-length"></span><span class="units-abbrev">"</span></td>
      <td class="compare-tent-column" style="cursor: pointer" onmouseover="highlightCompareTentSleepingLength()" onmouseout="resetHighlightStats()"><span id="compare-excess-sleeping-length"></span><span class="units-abbrev">"</span></td>
    </tr>
    <tr>
      <th>Extra Headroom Length</th>
      <td style="cursor: pointer" onmouseover="highlightTentHeadroomLength()" onmouseout="resetHighlightStats()"><span id="excess-headroom-length"></span><span class="units-abbrev">"</span></td>
      <td class="compare-tent-column" style="cursor: pointer" onmouseover="highlightCompareTentHeadroomLength()" onmouseout="resetHighlightStats()"><span  id="compare-excess-headroom-length"></span><span class="units-abbrev">"</span></td>
    </tr>
    <tr>
      <th>Extra Headroom Width</th>
      <td style="cursor: pointer" onmouseover="highlightTentHeadroomWidth()" onmouseout="resetHighlightStats()"><span id="excess-headroom-width"></span><span class="units-abbrev">"</span></td>
      <td class="compare-tent-column" style="cursor: pointer" onmouseover="highlightCompareTentHeadroomWidth()" onmouseout="resetHighlightStats()"><span  id="compare-excess-headroom-width"></span><span class="units-abbrev">"</span></td>
    </tr>
    <tr>
      <th>Weight</th>
      <td><span id="weight"></span><span class="units-weight-abbrev"> oz</span></td>
      <td class="compare-tent-column"><span id="compare-weight"></span><span class="units-weight-abbrev"> oz</span></td>
    </tr>
    <tr>
      <th>Manufacturer Link</th>
      <td><span id="manufacturer-link"></span></td>
      <td class="compare-tent-column"><span id="compare-manufacturer-link"></span></td>
    </tr>
    <tr id="compare-stats-row">
      <th>Notes</th>
      <td id="tent-notes"></td>
      <td class="compare-tent-column" id="tent-compare-notes" colspan="4"></td>
    </tr>
  </table>

  <div id="estimated" style="display: none">* = estimated</div>
</section>

<script type="text/javascript" src="tents.js"></script>
<script type="text/javascript" src="input.js"></script>
<script>
  
var gBrand = 'All brands';
var gTentName = '';
var gCompareTentName = '';
function pickBrand() {
  gBrand = document.getElementById("tent-brand-dropdown").value;
  rebuildTentDropDown(true);
}

function rebuildTentDropDown(skip_redraw) {
  var tentSelect = document.getElementById("tent-dropdown");
  var tentBrandSelect = document.getElementById("tent-brand-dropdown");
  var tentCompareSelect = document.getElementById("tent-compare-dropdown");
  while (tentSelect.options.length > 0) {
    tentSelect.remove(0);
  }
  while (tentBrandSelect.options.length > 0) {
    tentBrandSelect.remove(0);
  }
  while (tentCompareSelect.options.length > 0) {
    tentCompareSelect.remove(0);
  }
  var option = document.createElement("option");
  option.value = "None";
  option.text = "None";
  tentCompareSelect.appendChild(option);
  var option = document.createElement("option");
  option.value = "All brands";
  option.text = "All brands";
  tentBrandSelect.appendChild(option);
  for (i in brands) {
    var option = document.createElement("option");
    option.value = brands[i];
    option.text = brandAbbreviation(brands[i]);
    tentBrandSelect.appendChild(option);
  }
  tentBrandSelect.value = gBrand;
  var tentsToShow = [];
  for (i in gTents) {
    var tent = gTents[i];
    
    if (gBrand != "All brands" && gBrand != tent.brand) {
      continue;
    }
    
    tentsToShow.push(i);
  }
  tentsToShow.sort(function(a, b) {
    var aName = (gBrand == "All brands" ? brandAbbreviation(gTents[a].brand) + " " : "") + gTents[a].name;
    var bName = (gBrand == "All brands" ? brandAbbreviation(gTents[b].brand) + " " : "") + gTents[b].name;
    return aName.localeCompare(bName);
  });
  if (!tentsToShow.includes(gTentName)) {
    var option = document.createElement("option");
    option.value = gTentName;
    option.text = brandAbbreviation(gTents[gTentName].brand) + " " + gTents[gTentName].name;
    tentSelect.appendChild(option);
  }
  if (gCompareTentName && !tentsToShow.includes(gCompareTentName)) {
    var option = document.createElement("option");
    option.value = gCompareTentName;
    option.text = brandAbbreviation(gTents[gCompareTentName].brand) + " " + gTents[gCompareTentName].name;
    tentCompareSelect.appendChild(option);
  }
  for (var i in tentsToShow) {
    var name = tentsToShow[i];
    var option = document.createElement("option");
    option.value = name;
    option.text = (gBrand == "All brands" ? brandAbbreviation(gTents[name].brand) + " " : "") + gTents[name].name;
    tentSelect.appendChild(option);

    var option = document.createElement("option");
    option.value = name;
    option.text = (gBrand == "All brands" ? brandAbbreviation(gTents[name].brand) + " " : "") + gTents[name].name;
    tentCompareSelect.appendChild(option);
  }
  tentSelect.value = gTentName;
  tentCompareSelect.value = gCompareTentName;

  if (!skip_redraw) {
    drawFromSettings();
  }
}
  
var brands = new Set();
for (i in gTents) {
  brands.add(gTents[i].brand);
}
brands = Array.from(brands.values());
brands.sort();
  
// Canvas is global.
var gCanvasBottomPadding = 20;
gCanvas = document.getElementById("tent-side-canvas");
gCanvas.width = window.innerWidth - 20;
gCanvas.height = gCanvas.width / 2 + gCanvasBottomPadding;
gCanvas.addEventListener('mousemove', function(e) {
  updateHover(e.offsetX, e.offsetY);
  drawFromSettings();
});

var tentDropdown = document.getElementById("tent-dropdown");
tentDropdown.value = "BA Copper Spur HV UL2";
gTentName = "BA Copper Spur HV UL2";
gCompareTentName = "";

function toggleGeneric(element, show) {
  var options = document.getElementsByClassName(element);
  for (var i = 0; i < options.length; i++) {
    var option = options[i];
    if (show) {
      option.style.display = "table-row";
    } else {
      option.style.display = "none";
    }
  }
}

function drawFromSettings(changed) {
  profile = readProfile();

  var name = document.getElementById("tent-dropdown").value;
  var compareName = document.getElementById("tent-compare-dropdown").value;
  if (changed) {
    gTentName = name;
    gCompareTentName = compareName;
  }
  gSetValues["tent-dropdown"] = name;
  gSetValues["tent-compare-dropdown"] = compareName;
  if (compareName == "None") {
    compareName = false;
  }

  function handleGenericTent(tentName, assignName, rowClass, lengthEl, heightEl, widthEl) {
    if (tentName == "Generic A-Frame") {
      var tentLengthInches = checkInput(lengthEl, 50, 90);
      var tentHeightInches = checkInput(heightEl, 24, 42);
      var tentWidthInches = checkInput(widthEl, 20, 54);
      
      var headroomLength = tentLengthInches - 24;
      var headroomWidth = tentWidthInches * 0.9 * (tentHeightInches - 36) / (tentHeightInches - 6);
      if (tentHeightInches < 36) {
        headroomLength = 0;
        headroomWidth = 0;
      }

      gTents[assignName] = new Tent("Generic", assignName, OutlineType.Pyramid,
          [[0,6], [0, tentHeightInches], [tentLengthInches, tentHeightInches], [tentLengthInches,6], [0,6]],
          [[0,6], [tentWidthInches / 2, tentHeightInches], [tentWidthInches,6], [0,6]],
          tentLengthInches - 24, headroomLength, headroomWidth)  // usable dimension
          .setSideFootprint(12, tentLengthInches - 12)
          .setFrontFootprint(6, tentWidthInches - 6)
          .setRainflyWidth(0)
          .setInteriorPeakWidth(tentLengthInches - 24)
          .setIsTarp()
          .setWeight(11.5)
          .setPrice(100),

      toggleGeneric(rowClass, true);
      
      return formatInches(tentLengthInches) + " x " +
          formatInches(2 * Math.sqrt(tentWidthInches * tentWidthInches / 4 +
                         (tentHeightInches - 12) * (tentHeightInches - 12)));
    } else if (tentName == "Generic Dome") {
      var tentLengthInches = checkInput(lengthEl, 50, 90);
      var tentHeightInches = checkInput(heightEl, 37, 42);
      var tentWidthInches = checkInput(widthEl, 20, 54);

      function solveEllipse(a, b, y) {
          a = a / 2;  // Radius is half of length.
        return 2 * Math.sqrt(Math.abs((a * a) * (1 - (y * y) / (b * b))));
      }
      gTents[assignName] = new Tent("Generic", assignName, OutlineType.Dome,
               [tentLengthInches, tentHeightInches],
               [tentWidthInches, tentHeightInches],
               solveEllipse(tentLengthInches, tentHeightInches, 12) * 0.9,
               solveEllipse(tentLengthInches, tentHeightInches, 36) * 0.8,
               solveEllipse(tentWidthInches, tentHeightInches, 36) * 1.1)
          .setRainflyWidth(24);
      toggleGeneric(rowClass, true);
     } else if (tentName == "Generic Pyramid") {
      var tentLengthInches = checkInput(lengthEl, 50, 100);
      var tentHeightInches = checkInput(heightEl, 37, 49);
      var tentWidthInches = checkInput(widthEl, 20, 64);

      function solveTriangle(a, b, y) {
        var m = b / (a / 2);
        return a - 2 * y / m;
      }
      gTents[assignName] = new Tent("Generic", assignName, OutlineType.Pyramid,
              [[0,0], [tentLengthInches / 2, tentHeightInches], [tentLengthInches, 0]],
              [[0,0], [tentWidthInches * 1/2, tentHeightInches], [tentWidthInches,0]],
              solveTriangle(tentLengthInches, tentHeightInches, 12) * 0.95,
              solveTriangle(tentLengthInches, tentHeightInches, 36) * 0.95,
              solveTriangle(tentWidthInches * 2/3, tentHeightInches, 36) * 0.95,
              6, tentLengthInches - 6,
              tentWidthInches * 1/3, tentWidthInches - 6)
              //.setFrontInteriorPeakOffset(tentWidthInches * 1/3);
      toggleGeneric(rowClass, true);
    } else {
      toggleGeneric(rowClass, false);
    }
  }

  var aFrameSize = handleGenericTent(name, name, "generic-tent", "generic-tent-length-input", "generic-tent-height-input", "generic-tent-width-input");

  // Put the compare generic tent in a separate name.
  var compareAssignName = compareName;
  if (compareName && compareName.startsWith("Generic ")) {
    compareAssignName += " Compare";
  }
  var compareAFrameSize = handleGenericTent(compareName, compareAssignName, "generic-compare-tent", "generic-compare-tent-length-input", "generic-compare-tent-height-input", "generic-compare-tent-width-input");

  drawTent(
      name, compareAssignName, profile);

  var usable = document.getElementById("usable-area-label");
  if (usable) {
    usable.innerHTML = name + " Usable Area";
  }

  var usable = document.getElementById("compare-label");
  if (compareName) {
    usable.style.display = "table-cell";
    usable.innerHTML = compareName + " Usable Area";
  } else {
    usable.style.display = "none";
  }

  var estimated = false;
  var tent = gTents[name];
  [headLength, headWidth] = tent.getExtraHeadWidthsAtHeight(
      profile, profile.sittingHeight);
  sleepingLength = tent.getLayingWidthAtHeight(profile.sleepingHeights());

  document.getElementById("tent-name-stats").innerHTML = tent.name;
  if (name == "Generic A-Frame") {
    document.getElementById("tent-name-stats").innerHTML += "<br/>" + aFrameSize;
  }
  document.getElementById("excess-sleeping-length").innerHTML = outputLength(
      sleepingLength - profile.sleepingLength());
  document.getElementById("excess-headroom-length").innerHTML =
      outputLength(headLength);
  document.getElementById("excess-headroom-width").innerHTML =
      outputLength(headWidth);
  if (tent.weight) {
    document.getElementById("weight").innerHTML = outputWeight(tent.weight);
  } else {
    document.getElementById("weight").innerHTML = ""; 
  }
  if (tent.url) {
    document.getElementById("manufacturer-link").innerHTML = "<a href=\"" + tent.url + "\" target=\"poup\">" + tent.brand + "</a>";
  }
  if (tent.estimated) {
    estimated = true;
    document.getElementById("tent-name-stats").innerHTML += " *";
  }
  if (tent.panelPullouts) {
    document.getElementById("tent-name-stats").innerHTML += " (with pullouts)";
  }
  if (tent.note) {
    document.getElementById("tent-notes").innerHTML = tent.note;
  } else {
    document.getElementById("tent-notes").innerHTML = "";
  }
  if (compareName) {
    var compareCells = document.getElementsByClassName("compare-tent-column");
    for (var i = 0; i < compareCells.length; i++) {
      compareCells[i].style.display = "table-cell";
    }

    var tent = gTents[compareAssignName];
    [headLength, headWidth] = tent.getExtraHeadWidthsAtHeight(profile, profile.sittingHeight);
    sleepingLength = tent.getLayingWidthAtHeight(profile.sleepingHeights());
    document.getElementById("tent-compare-name-stats").innerHTML = tent.name;
    if (compareName == "Generic A-Frame") {
      document.getElementById("tent-compare-name-stats").innerHTML += "<br/>" + compareAFrameSize;
    }
    document.getElementById("compare-excess-sleeping-length").innerHTML =
        outputLength(sleepingLength - profile.sleepingLength());
    document.getElementById("compare-excess-headroom-length").innerHTML =
        outputLength(headLength);
    document.getElementById("compare-excess-headroom-width").innerHTML =
        outputLength(headWidth);
    if (tent.weight) {
      document.getElementById("compare-weight").innerHTML = outputWeight(tent.weight);
    } else {
      document.getElementById("compare-weight").innerHTML = "";
    }
    if (tent.url) {
      document.getElementById("compare-manufacturer-link").innerHTML = "<a href=\"" + tent.url + "\" target=\"poup\">" + tent.brand + "</a>";
    }
    var el = document.getElementById("compare-stats-row");
    if (el) {
      el.style.display = "table-row";
    }
    if (tent.estimated) {
      estimated = true;
      document.getElementById("tent-compare-name-stats").innerHTML += " *";
    }
    if (tent.panelPullouts) {
      document.getElementById("tent-compare-name-stats").innerHTML +=
          " (with pullouts)";
    }
    if (tent.note) {
      document.getElementById("tent-compare-notes").innerHTML = tent.note;
    } else {
      document.getElementById("tent-compare-notes").innerHTML = "";
    }
  } else {
    var compareCells = document.getElementsByClassName("compare-tent-column");
    for (var i = 0; i < compareCells.length; i++) {
      compareCells[i].style.display = "none";
    }
  }
  
  if (estimated) {
    document.getElementById("estimated").style.display = "block";
  } else {
    document.getElementById("estimated").style.display = "none";
  }

  if (changed) {
    writeCookie();
  }

  // Set the self-link.
  var link = window.location.origin + window.location.pathname;
  link += "?tent-dropdown=" + name;
  var linkElements = [];
  if (name.startsWith("Generic ")) {
    linkElements = linkElements.concat(["generic-tent-length-input",
                                        "generic-tent-width-input",
                                        "generic-tent-height-input"]);
  }
  if (compareName) {
    linkElements.push("tent-compare-dropdown");
    if (compareName.startsWith("Generic ")) {
      linkElements = linkElements.concat(["generic-compare-tent-length-input",
                                          "generic-compare-tent-width-input",
                                          "generic-compare-tent-height-input"]);
    }
  }
  linkElements.forEach(el => {
    if (gSetValues[el]) {
      link += "&" + el + "=" + gSetValues[el];
    }
  });
  var linkEl = document.getElementById("self-link");
  if (linkEl) {
    linkEl.href = link;
  }
}

function highlightTent() {
  gHighlightStats = HighlightStats.USABLE_AREA;
  drawFromSettings(false);
}

function highlightCompare() {
  gHighlightStats = HighlightStats.COMPARE_USABLE_AREA;
  drawFromSettings(false);
}

function highlightTentSleepingLength() {
  gHighlightStats = HighlightStats.SLEEPING_LENGTH;
  drawFromSettings(false);
}

function highlightCompareTentSleepingLength() {
  gHighlightStats = HighlightStats.COMPARE_SLEEPING_LENGTH;
  drawFromSettings(false);
}

function highlightTentHeadroomLength() {
  gHighlightStats = HighlightStats.HEADROOM_LENGTH;
  drawFromSettings(false);
}

function highlightCompareTentHeadroomLength() {
  gHighlightStats = HighlightStats.COMPARE_HEADROOM_LENGTH;
  drawFromSettings(false);
}

function highlightTentHeadroomWidth() {
  gHighlightStats = HighlightStats.HEADROOM_WIDTH;
  drawFromSettings(false);
}

function highlightCompareTentHeadroomWidth() {
  gHighlightStats = HighlightStats.COMPARE_HEADROOM_WIDTH;
  drawFromSettings(false);
}

function resetHighlightStats() {
  gHighlightStats = false;
  drawFromSettings(false);
}

rebuildTentDropDown(true);

decodeCookie();
decodeGetParams();

drawFromSettings(false);
addInputListeners(function(e) { drawFromSettings(true); });
 
</script>

</body>
</html>

